
trigger: none
pr: none

schedules:
- cron: '0 6 * * 1-5'
  displayName: ScheduledRun
  branches:
    include:
      - master
  always: true

parameters:
- name: projectName
  displayName: Project Name
  type: string

variables:
  - name: BuildConfiguration
    value: release
  - name: BuildPlatform
    value: any cpu
  - group: "Release Automation Suite Variables"
  - group: "Provider Release Automation Suite Variables"
  - name: Deploy
    value: $[or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.Reason'], 'Manual'), eq(variables['Build.Reason'], 'PullRequest'))]

resources:
  repositories:
    - repository: self
    - repository: das-platform-building-blocks
      type: github
      name: SkillsFundingAgency/das-platform-building-blocks
      ref: refs/tags/3.0.23
      endpoint: SkillsFundingAgency
    - repository: das-platform-automation
      type: github
      name: SkillsFundingAgency/das-platform-automation
      ref: refs/tags/5.1.21
      endpoint: SkillsFundingAgency

pool:
  vmImage: 'windows-latest'

stages:

- stage: Validate
  displayName: "Validate Input Parameters"
  jobs:
    - job: ValidateParams
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - script: |
            if [ -z "${{ parameters.projectName }}" ]; then
              echo "ERROR: projectName cannot be empty."
              exit 1
            fi
          displayName: "Validate projectName is not empty"


- stage: RunEnvironmentStage
  displayName: "Environment Build/Deploy Stage"
  jobs:
    - template: ../pipeline-templates/stage/enviroment-stage.yml
      parameters:
        projectName: ${{ parameters.projectName }}
        BuildConfiguration: $(BuildConfiguration)
        deploy: $(Deploy)
